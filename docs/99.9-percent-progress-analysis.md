# 数据同步任务进度卡在 99.9% 的排查分析

## 现象

- 客户 E2E 测试中，同步任务长时间停留在 **状态=Running, 进度=99.9%**（从约 911s 到 1300s+）。
- 日志来自 `server_e2e_test.go` 的轮询逻辑（SSE 断开后的 `pollWorkflowUntilComplete`），每 5 秒打印一次进度。

## 结论摘要

**根本原因：有且仅有 1 个任务始终未完成**，导致：

1. **进度**：`(Completed + Failed) / Total = 999/1000 = 99.9%`，由内存快照 `GetProgress()` 计算得到。
2. **状态**：引擎侧 `instance.Status` 仍为 `"Running"`，因为“全部完成”检查从未通过，所以不会置为 `"Success"`。
3. **适配层**：`GetInstanceStatus` 优先用内存快照算进度；当 `statusStr` 不是终态时，不会强制把进度改成 100%，因此接口一直返回 99.9% + Running。

也就是说：**不是“进度算错”，而是“最后一个任务一直没完成”**。

---

## 1. 进度与状态的数据流

### 1.1 进度从哪里来

- **Adapter**（`examples/adapter.go`）：
  - 若 `GetInstanceProgress(instanceID)` 有快照，则：
    - `progress = (Completed + Failed) / Total * 100`
    - 若 `done == taskCount` 则 `progress = 100` 且 `finalStatus = Success/Failed`
  - 若引擎返回的 `statusStr` 已是终态（SUCCESS/COMPLETED/FAILED 等），会强制 `progress = 100`、`finalStatus = statusStr`。

- **Engine**（`pkg/core/engine/engine.go`）：
  - `GetInstanceProgress` 从对应 `WorkflowInstanceManager` 的 `GetProgress()` 取内存快照。

- **V2 Manager**（`instance_manager_v2.go`）：
  - `GetProgress()` 基于原子变量 `taskStats`：
    - `TotalTasks`, `SuccessTasks`, `FailedTasks`, `PendingTasks`
    - `Running = Total - Completed - Failed - Pending`
  - 进度等价于 `(SuccessTasks + FailedTasks) / TotalTasks * 100`。

因此：**99.9% 等价于 (SuccessTasks + FailedTasks) = 999 且 TotalTasks = 1000**，即还有 1 个任务未计入完成/失败。

### 1.2 状态何时变为 Success

- 在 **queueManagerGoroutine** 主循环中：
  - 每次处理完 `queueUpdateChan` 事件后会 `drainTaskStatsChan()`，再读 `taskStats` 的 success/failed/total。
  - 当 `completed >= totalCount` 且 `checkAllTasksCompleted(completed, totalCount)` 为 true 时，才设置 `instance.Status = "Success"`（或 Failed）并写库、发状态更新。
- `GetWorkflowInstanceStatus` 在实例仍由 manager 管理时，直接返回 `manager.GetStatus()`，即内存里的 `instance.Status`。

所以：**只要“全部完成”检查不通过，状态就会一直停在 Running，接口就一直是 99.9% + Running。**

---

## 2. 为什么“全部完成”检查不通过？

可能只有两类情况：

- **A）真的还有 1 个任务没完成**  
  - taskStats 为 999 完成 / 1000 总数（另 1 个在 Pending 或 Running）。
  - 主循环永远等不到“第 1000 个完成”事件，`completed >= totalCount` 不成立，不会进入“全部完成”逻辑。

- **B）所有任务都已完成，但 checkAllTasksCompleted 返回 false**  
  - 此时 taskStats 已是 1000/1000，GetProgress() 会给出 100%；
  - Adapter 里 `done == taskCount` 成立会设 `progress = 100`、`finalStatus = "Success"`。
  - 这样就不会出现“长时间 99.9%”的现象。

因此，**能稳定复现“卡在 99.9%”的只能是情况 A：有 1 个任务始终未完成。**

---

## 3. 那 1 个未完成任务可能卡在哪？

- **Executor 未回调**：任务在 executor 内已做完，但结果未通过 callback 送回，或 callback 未执行。
- **任务本身卡住**：例如某个表/API 的同步一直阻塞（网络、限流、死锁、无限重试等）。
- **事件未进入主循环**：理论上若最后一个完成事件一直没被 `queueUpdateChan` 消费（例如主循环卡在 `handleTaskCompletion` 里的某处），也会导致“统计上少 1 个完成”；但此时统计上应是 999/1000，与 99.9% 一致，仍表现为“1 个任务未完成”。

所以从产品表现上，更直接的解释是：**有 1 个同步子任务（或 1 个 table/API）从未完成**，而不是引擎内部“完成统计”写错。

---

## 4. 建议的排查与改进

### 4.1 建议一：在进度 API 中暴露“未完成”任务信息（推荐）

- 在返回进度/状态时，增加例如：
  - `running_task_ids` / `pending_task_ids`，或
  - `last_running_task_name`、`pending_count`。
- 这样当卡在 99.9% 时，可以直接看到是哪一个（或哪几个）任务还在 Running/Pending，便于对客户环境定位是哪个表或哪一步卡住。

实现位置建议：

- `pkg/core/types/instance_manager.go`：在 `ProgressSnapshot` 或新结构体中增加可选字段（如 `RunningTaskIDs []string`）。
- V2 Manager 的 `GetProgress()`：在现有统计基础上，从队列/运行时任务中收集当前 Running/Pending 的 task id 或 name 填入。
- Adapter 的 `GetInstanceStatus`：把上述信息映射到对外 API 的 progress/status 响应中。

### 4.2 建议二：任务级超时与失败处理

- 为每个同步子任务配置超时（或使用引擎已有的 task timeout）；超时后将该任务标记为失败，并继续推进统计。
- 这样即使有 1 个任务永久卡住，最终也会以“失败”结束，不会无限停在 99.9%，同时便于发现异常表/API。

### 4.3 建议三：Adapter 侧“乐观 100%”的可选策略（慎用）

- 当 `(Completed + Failed) == Total` 且长时间（如 >5 分钟）无新进展时，可将进度显示为 100%，并把状态显示为“完成（部分失败）”或保留 Running 但带提示。
- 这会改善“界面一直 99.9%”的体验，但会掩盖“有 1 个任务卡住”的事实，建议仅作为可选策略或调试模式，且与“暴露未完成任务”一起使用。

### 4.4 建议四：日志与可观测性

- 在 V2 的完成检查分支中，已有“任务计数检查”等日志；可补充：
  - 当 `completed >= totalCount` 但 `checkAllTasksCompleted` 为 false 时，打印当前 `taskStats`、层级、队列是否为空等，便于区分是“统计不一致”还是“队列/层级未推进”。
- 若启用“未完成任务 id”的返回，可在日志中同步打印这些 id，便于和客户日志对照。

---

## 5. 小结

| 项目       | 说明 |
|------------|------|
| 现象       | 进度长期 99.9%，状态 Running。 |
| 直接原因   | 内存快照 (Completed+Failed)/Total = 999/1000；实例状态未变为 Success。 |
| 根本原因   | 有 1 个任务从未完成（未上报完成/失败），导致“全部完成”检查永远不通过。 |
| 建议优先级 | 1）暴露 Running/Pending 任务信息；2）任务超时与失败处理；3）可选“乐观 100%”；4）增强日志。 |

若需要，我可以基于当前代码结构给出“暴露未完成任务 ID”的具体改法（包含 types、GetProgress、Adapter 和 API 返回格式）。
