### 一、配置特性核心定位

本次设计中配置体系围绕「**分层解耦、灵活可控、安全可靠、易扩展**」核心目标构建，核心是**框架配置与业务配置严格分离**，同时覆盖配置从「加载-校验-使用-热更新」的全生命周期管理，适配生产级部署要求。

### 二、核心配置特性详细描述

#### 1. 【核心】配置分层设计（框架/业务彻底解耦）

| 配置类型 | 载体文件                        | 核心内容                                                                          | 特性说明                                                                             |
| -------- | ------------------------------- | --------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------ |
| 框架配置 | `framework.yaml`              | 通用底层能力配置：SQLite路径、缓存TTL、Worker并发数、全局超时/重试规则、日志级别  | 无任何业务耦合，可在多业务（如Tushare/Wind数据同步）间复用；启动后只读，保障底层稳定 |
| 业务配置 | `workflows/tushare-sync.yaml` | 专属业务规则配置：Tushare同步的Job定义、回调规则、Workflow结构、任务超时、API字段 | 独立于框架，仅关联业务逻辑；可按同步维度拆分多文件（如日线/财务数据分开配置）        |

#### 2. 配置隔离特性（环境/职责/敏感信息三重隔离）

- **环境隔离**：
  - 框架配置支持多环境版本（dev/test/prod），如dev环境用本地SQLite、低并发，prod环境用高并发配置；
  - 业务配置可按环境调整核心参数（如dev同步测试日期、prod同步全量日期），通过 `${ENV}`内置变量自动适配。
- **职责隔离**：
  - 框架配置（存储、并发、重试）由运维管理，聚焦基础设施稳定性；
  - 业务配置（同步规则、字段、超时）由开发管理，聚焦业务逻辑调整，双方互不干涉。
- **敏感信息隔离**：
  - Tushare Token等敏感信息不混入任何配置文件，业务侧通过环境变量（如 `TUSHARE_TOKEN`）注入；
  - 框架配置仅包含通用路径/规则，无任何业务敏感数据。

#### 3. 配置加载与校验（提前暴露问题，避免运行时异常）

- **多文件灵活加载**：
  - 业务配置支持多文件合并加载（如拆分 `daily-sync.yaml`/`finance-sync.yaml`），框架自动合并为统一配置集；
  - 支持环境变量替换（如 `${DB_PATH}`），适配不同部署环境的路径差异。
- **默认值兜底**：
  - 框架配置缺失字段自动填充默认值（如Worker并发数默认5、全局超时默认30s）；
  - 业务配置缺失字段继承框架默认（如单个Job未配置超时则继承全局30s，Tushare API字段默认填充核心字段）。
- **合法性校验**：
  - 语法校验：加载时校验YAML格式、字段类型（如日期格式、超时时间单位）；
  - 逻辑校验：校验Workflow任务依赖的TaskID是否存在、JobID是否已注册、超时时间是否合理（不超过全局3倍）；
  - 提前失败：所有配置错误在加载阶段暴露，避免运行时触发异常。

#### 4. 配置热更新（业务规则动态调整，无需重启）

- **业务配置独立热更**：
  - 修改业务配置（如同步日期、任务超时、API字段）后，调用 `HotReloadWorkflows`接口即可生效，框架无需重启；
  - 热更新仅影响未执行的任务，正在运行的任务不受干扰。
- **并发安全保障**：
  - 热更新过程通过读写锁实现并发安全，更新时读任务正常执行，写操作完成后新配置立即生效；
  - 框架配置启动后只读，避免热更新底层配置（如存储路径）引入稳定性风险。

#### 5. 配置与任务的联动（配置驱动任务执行）

- **动态参数解析**：
  - 业务配置支持内置变量（`${ENV}`/`${NOW}`），加载时自动替换为实际值（如 `${ENV}`替换为dev/prod，`${NOW}`替换为当前时间）；
  - 任务参数可通过配置动态注入，无需硬编码（如交易日参数从配置读取，而非写死在任务函数）。
- **分级配置覆盖**：
  - 全局默认（框架）→ Job级自定义（业务）→ Task级自定义，支持精细化控制（如财务数据任务超时60s，覆盖全局30s）；
  - Workflow任务依赖关系完全由配置定义，框架自动解析并生成执行计划。
- **配置驱动任务生成**：
  - Workflow的执行逻辑完全由业务配置定义，启动时仅需传入 `WorkflowID`，框架自动加载配置、生成任务执行链；
  - 动态任务生成（如按交易日生成下载任务）的核心参数（同步日期范围）由业务配置提供，任务函数无硬编码。

#### 6. 配置复用与扩展（低成本适配新场景）

- **框架配置复用**：一套 `framework.yaml`可支撑多个业务Workflow（如Tushare同步、Wind数据同步），无需重复定义存储/并发规则；
- **业务配置扩展**：
  - 新增同步维度（如分钟线数据）仅需在业务配置中新增Job/Workflow定义，无需改动框架代码；
  - 配置结构标准化（统一的Job/Callback/Workflow YAML结构），便于自动化解析、文档生成、配置审计；
- **配置向后兼容**：新增配置字段时保留旧逻辑，旧配置文件无需修改即可正常加载（默认值兜底）。

### 三、配置特性核心价值

1. **解耦提效**：框架与业务配置分离，开发调整同步规则仅需改业务配置，运维调整基础设施仅需改框架配置，互不影响；
2. **灵活适配**：热更新+分级覆盖+动态参数，可快速响应业务需求变化（如调整同步日期、适配API限流）；
3. **安全可靠**：敏感信息隔离+配置校验+框架配置只读，避免配置层面的安全风险和运行时故障；
4. **易扩展维护**：配置复用+标准化结构，新增业务场景（如新增财务指标同步）仅需扩展业务配置，无需重构框架。

## 四、配置样例

### 一、框架配置样例（通用、无业务耦合）

#### 1. 开发环境框架配置（`config/framework/dev.yaml`）

yaml

```yaml
# 纯框架通用配置，适用于开发环境，无任何业务内容
task-engine:
  # 基础通用配置
  general:
    log_level: "debug"                    # 日志级别：debug/info/warn/error
    env: "dev"                            # 运行环境标识

  # 存储配置（SQLite/缓存）
  storage:
    database:
      type: "sqlite"                      # 保持SQLite类型不变
      dsn: "./quant_data_dev.db?cache=shared&_journal_mode=WAL&_sync=normal"  # 替换原path为DSN，新增WAL参数
      max_open_conns: 3                   # WAL模式下连接数建议≤5（避免锁冲突）
      max_idle_conns: 1
      conn_max_lifetime: "2h"
      conn_max_idle_time: "1h"            # 新增：适配WAL模式的空闲连接回收

    cache:
      enabled: true                       # 开启缓存（避免重复请求）
      default_ttl: "1h"                   # 缓存默认过期时间
      clean_interval: "30m"               # 缓存清理间隔

  # 执行规则配置（全局通用）
  execution:
    default_task_timeout: "30s"           # 任务默认超时（适配Tushare API请求）
    worker_concurrency: 3                 # 开发环境低并发（避免API限流）
    retry:                                # 全局重试规则
      enabled: true
      max_attempts: 3                     # 最大重试次数
      delay: "1s"                         # 重试间隔
      max_delay: "5s"                     # 最大重试间隔（指数退避）
```

#### 2. 生产环境框架配置（`config/framework/prod.yaml`）

yaml

```yaml
# 生产环境框架配置，聚焦稳定性和高并发
task-engine:
  general:
    instance_name: "quant-data-sync-prod"
    log_level: "info"
    env: "prod"

  storage:
    database:
      type: "postgres"                      # 数据库类型：从sqlite改为postgres
      dsn: "host=prod-db.example.com port=5432 user=quant sync password=prod@123456 dbname=quant_data sslmode=require pool_max_conns=20"  # PostgreSQL DSN（替换原path字段）
      max_open_conns: 20                    # PostgreSQL连接池最大打开连接数（适配生产高并发）
      max_idle_conns: 10                    # 最大空闲连接数
      conn_max_lifetime: "4h"               # 连接最大存活时间
      conn_max_idle_time: "1h"              # 新增：PostgreSQL连接最大空闲时间（可选）

    cache:
      enabled: true
      default_ttl: "2h"
      clean_interval: "1h"

  execution:
    default_task_timeout: "60s"               # 生产环境更长超时
    worker_concurrency: 8                     # 高并发（需匹配Tushare API限流）
    retry:
      enabled: true
      max_attempts: 5                         # 更多重试次数
      delay: "2s"
      max_delay: "10s"
```


### 二、业务配置样例

yaml

```yaml
# config/workflows/tushare-sync.yaml
# 核心调整：
# 1. Callback不再独立配置，直接内聚到所属Task节点下
# 2. 所有同步相关任务（交易日历、日线、财务）归属同一个Workflow
workflows:
  # Job定义（仅做函数映射，回调逻辑移至Task层级）
  jobs:
    - job_id: "tushare-tradecal-job"
      func_key: "tradeCalJob"
      description: "获取交易日历并生成下载任务"
      timeout: "30s"

    - job_id: "tushare-daily-job"
      func_key: "dailyDownloadJob"
      description: "下载单交易日日线数据并入库"
      timeout: "60s"

    - job_id: "tushare-finance-job"
      func_key: "financeDownloadJob"
      description: "下载单交易日财务数据并入库"
      timeout: "60s"

  # Workflow定义（所有同步任务归属同一个Workflow）
  definitions:
    - workflow_id: "tushare-sync-workflow"
      description: "Tushare日线+财务数据同步工作流（单Workflow聚合所有任务）"
      tasks:
        # 核心Task1：获取交易日历（动态生成子任务）
        - task_id: "tradecal-task"
          job_id: "tushare-tradecal-job"
          params: {}
          dependencies: []
          # 该Task专属Callback（内聚到Task节点）
          callbacks:
            - state: "success"
              func_key: "syncSuccessCallback"
              description: "交易日历获取成功回调"
            - state: "failed"
              func_key: "syncFailedCallback"
              description: "交易日历获取失败回调（触发告警）"

        # 动态生成Task的模板配置（日线下载）
        # 注：动态生成的task会继承此配置的callback规则
        - task_id: "daily-task-template"
          job_id: "tushare-daily-job"
          params: {}
          dependencies: []
          callbacks:
            - state: "success"
              func_key: "syncSuccessCallback"
              description: "日线数据同步成功回调"
            - state: "failed"
              func_key: "syncFailedCallback"
              description: "日线数据同步失败回调（触发告警）"

        # 动态生成Task的模板配置（财务数据下载）
        - task_id: "finance-task-template"
          job_id: "tushare-finance-job"
          params: {}
          dependencies: []
          callbacks:
            - state: "success"
              func_key: "syncSuccessCallback"
              description: "财务数据同步成功回调"
            - state: "failed"
              func_key: "syncFailedCallback"
              description: "财务数据同步失败回调（触发告警）"
```
