# 子任务全生命周期测试点（生成/执行/回调/结果/参数）

结合量化数据下载场景（pro_bar/trade_cal）和任务引擎的核心逻辑，以下是**覆盖子任务全生命周期的关键测试点**，按「参数注入→生成→DAG调整→执行→回调→结果传递→异常边界」分层拆解，每个测试点包含「测试目的、测试场景、预期结果」，可直接落地测试用例。

## 一、核心测试维度总览

| 测试维度    | 核心覆盖环节                     | 量化场景示例                                     |
| ----------- | -------------------------------- | ------------------------------------------------ |
| 参数注入    | 子任务参数来源/合法性/传递准确性 | pro_bar子任务注入trade_date/stock_code           |
| 子任务生成  | 触发条件/生成规则/数量/唯一性    | 基于trade_cal生成交易日维度子任务                |
| DAG动态调整 | 节点插入/依赖重构/拓扑排序       | 子任务插入后index依赖改为子任务                  |
| 子任务执行  | 顺序/并发/重试/补偿/超时         | 子任务按DAG顺序执行，batchSize控制并发           |
| 回调触发    | 时机/数据/隔离性/顺序            | 子任务成功触发日志回调，失败触发告警             |
| 结果传递    | 回传/聚合/持久化/下游消费        | 父任务聚合子任务成功率，index获取子任务数据      |
| 异常边界    | 空数据/部分失败/环检测/性能      | 无交易日时子任务不生成，部分子任务失败不影响整体 |

## 二、详细测试点（可直接落地用例）

### 1. 参数注入测试（基础：子任务的「输入」正确性）

| 测试点ID  | 测试目的               | 测试场景                                                                                       | 预期结果                                                                                     |
| --------- | ---------------------- | ---------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------- |
| PARAM-001 | 验证参数来源完整性     | 生成pro_bar子任务时，注入「用户参数（start_date）+依赖数据（trade_date）+固定参数（API Key）」 | 子任务Params包含：start_date=20250101、trade_date=20250101、api_key=xxx、fields=ts_code,open |
| PARAM-002 | 验证参数类型正确性     | trade_date为数字类型（20250101），注入子任务后强制转为字符串                                   | 子任务Params["trade_date"]为string类型，值为"20250101"                                       |
| PARAM-003 | 验证缺失依赖参数的处理 | 生成pro_bar子任务时，缺失stock_basic的stock_code依赖参数                                       | 子任务生成失败，父任务返回错误：「缺失stock_code依赖数据」，DAG不调整                        |
| PARAM-004 | 验证非法参数的校验     | 用户传入start_date=20251301（无效月份），注入子任务前校验                                      | 参数校验失败，子任务不生成，父任务触发失败钩子                                               |
| PARAM-005 | 验证参数传递的准确性   | 父任务用户参数end_date=20250131，传递给所有子任务                                              | 所有pro_bar子任务的Params["end_date"]均为"20250131"，无篡改                                  |
| PARAM-006 | 验证动态参数注入       | 子任务执行中，从缓存补充最新的ts_code列表到参数                                                | 子任务执行时Params["ts_codes"]为缓存最新值，而非生成时的旧值                                 |

### 2. 子任务生成测试（核心：生成规则/触发条件）

| 测试点ID | 测试目的                     | 测试场景                                             | 预期结果                                                        |
| -------- | ---------------------------- | ---------------------------------------------------- | --------------------------------------------------------------- |
| GEN-001  | 验证生成触发条件（依赖通过） | trade_cal/stock_basic未执行，触发pro_bar子任务生成   | 生成失败，提示「依赖任务未完成」，DAG无变化                     |
| GEN-002  | 验证生成触发条件（缓存短路） | 缓存中存在pro_bar 20250101-20250103全量数据          | 子任务不生成，父任务直接标记成功，触发「缓存命中」钩子          |
| GEN-003  | 验证维度拆分规则             | trade_cal返回3个交易日，stock_basic返回2个股票代码   | 生成3×2=6个pro_bar子任务，每个子任务对应「单交易日+单股票」    |
| GEN-004  | 验证子任务ID唯一性           | 生成多个子任务，ID包含父任务ID+trade_date+stock_code | 子任务ID如「step_pro_bar_sub_20250101_000001」，无重复          |
| GEN-005  | 验证空数据生成逻辑           | trade_cal返回空交易日列表（非交易日范围）            | 子任务数量为0，父任务标记「无数据」，触发成功钩子（成功率100%） |
| GEN-006  | 验证批量生成限制             | 配置batchSize=5，需生成10个子任务                    | 分2批生成，每批5个，无一次性生成10个                            |
| GEN-007  | 验证重复生成防护             | 父任务重启后，重复触发生成逻辑                       | 检测到已生成子任务，跳过重复生成，复用原有子任务                |

### 3. DAG动态调整测试（关键：拓扑正确性）

| 测试点ID | 测试目的           | 测试场景                                             | 预期结果                                                       |
| -------- | ------------------ | ---------------------------------------------------- | -------------------------------------------------------------- |
| DAG-001  | 验证子节点插入位置 | 父节点pro_bar后插入子节点，下游为index               | 子节点位于pro_bar和index之间，拓扑顺序：pro_bar→子节点→index |
| DAG-002  | 验证依赖关系重构   | 原index依赖pro_bar，插入子节点后                     | index的依赖改为所有pro_bar子节点，pro_bar的依赖不变            |
| DAG-003  | 验证拓扑排序正确性 | 插入10个子任务后，执行Kahn算法重排序                 | 拓扑顺序符合「父→子1→子2→…→index」，无环、无顺序错乱      |
| DAG-004  | 验证环检测逻辑     | 手动构造子节点依赖下游index，index又依赖父节点       | DAG调整失败，提示「存在环」，回滚子任务生成，恢复原DAG         |
| DAG-005  | 验证多父节点场景   | index同时依赖pro_bar和index_basic，pro_bar生成子节点 | index仅依赖pro_bar的子节点，index_basic的依赖不变              |
| DAG-006  | 验证子节点下游为空 | pro_bar无下游节点，生成子节点后                      | 子节点为DAG末端节点，拓扑顺序最后为子节点                      |

### 4. 子任务执行测试（核心：执行逻辑/状态）

| 测试点ID | 测试目的           | 测试场景                                | 预期结果                                                         |
| -------- | ------------------ | --------------------------------------- | ---------------------------------------------------------------- |
| EXEC-001 | 验证执行顺序       | 子任务依赖父节点pro_bar，pro_bar未执行  | 子任务处于pending状态，等待pro_bar执行完成后启动                 |
| EXEC-002 | 验证并发控制       | 配置batchSize=3，生成6个子任务          | 同时运行的子任务数≤3，剩余3个等待，无超并发执行                 |
| EXEC-003 | 验证子任务独立重试 | 单个子任务因API限流失败，配置重试次数=3 | 该子任务重试3次，成功后标记为success，其他子任务正常执行         |
| EXEC-004 | 验证部分失败处理   | 6个子任务中2个失败，成功率阈值=80%      | 成功率=4/6≈66.7%<80%，父任务标记failed，触发失败钩子            |
| EXEC-005 | 验证超时处理       | 子任务超时时间=5min，API响应耗时10min   | 子任务标记为timeout/failed，计入失败数，不阻塞其他子任务         |
| EXEC-006 | 验证补偿逻辑       | 父任务触发补偿，子任务已成功执行        | 遍历所有子任务执行补偿（删除数据+缓存），子任务标记为compensated |
| EXEC-007 | 验证子任务跳过逻辑 | 子任务缓存命中，配置「跳过执行」        | 子任务标记为skipped，不计入失败数，成功率统计为100%              |

### 5. 回调触发测试（扩展：钩子完整性/隔离性）

| 测试点ID | 测试目的              | 测试场景                                           | 预期结果                                                                    |
| -------- | --------------------- | -------------------------------------------------- | --------------------------------------------------------------------------- |
| HOOK-001 | 验证回调类型覆盖      | 子任务经历start→success→compensate全生命周期     | 触发HookTypeSubTaskStart、HookTypeSubTaskSuccess、HookTypeSubTaskCompensate |
| HOOK-002 | 验证回调时机准确性    | 子任务执行成功后立即触发success回调                | 回调触发时间在子任务end_time之后，父任务汇总之前                            |
| HOOK-003 | 验证回调数据准确性    | 子任务success回调传递data_count/trade_date         | 回调上下文包含：data_count=100、trade_date=20250101、sub_task_id=xxx        |
| HOOK-004 | 验证回调失败隔离      | 日志回调因文件权限失败，不影响子任务状态           | 回调失败仅记录日志，子任务仍标记为success，主流程不中断                     |
| HOOK-005 | 验证多回调顺序执行    | 子任务success绑定「日志+邮件+缓存」3个回调         | 按注册顺序执行3个回调，前一个失败不影响后一个                               |
| HOOK-006 | 验证全局/局部回调区分 | 全局success回调（所有子任务触发）+ pro_bar局部回调 | pro_bar子任务触发2个回调，index子任务仅触发全局回调                         |

### 6. 结果传递测试（核心：数据流转）

| 测试点ID | 测试目的             | 测试场景                                       | 预期结果                                                   |
| -------- | -------------------- | ---------------------------------------------- | ---------------------------------------------------------- |
| RES-001  | 验证子任务结果回传   | 子任务执行完成后，结果传递给父任务             | 父任务subTaskResults包含所有子任务的data_count/error_msg   |
| RES-002  | 验证结果聚合逻辑     | 6个子任务5个成功（data_count=100/个），1个失败 | 父任务汇总：total=6、success=5、failed=1、total_data=500   |
| RES-003  | 验证结果持久化       | 子任务结果写入数据库/缓存                      | 存储中可查询到子任务ID→结果的映射，缓存有效期符合配置     |
| RES-004  | 验证下游节点消费结果 | index任务依赖pro_bar子任务，读取子任务结果     | index任务可获取所有pro_bar子任务的data_count，用于数据校验 |
| RES-005  | 验证空结果处理       | 子任务执行成功但无数据（data_count=0）         | 父任务汇总包含空结果，标记为success，无panic               |
| RES-006  | 验证结果覆盖逻辑     | 子任务重试后结果更新                           | 父任务subTaskResults覆盖为最新重试结果，旧结果归档         |

### 7. 异常边界测试（兜底：鲁棒性）

| 测试点ID | 测试目的                     | 测试场景                                                 | 预期结果                                                                    |
| -------- | ---------------------------- | -------------------------------------------------------- | --------------------------------------------------------------------------- |
| BND-001  | 验证子任务生成失败回滚       | 生成子任务时DAG调整失败                                  | 已生成的子任务被清理，DAG恢复原结构，父任务标记failed                       |
| BND-002  | 验证子任务执行全失败         | 所有子任务因API密钥错误失败                              | 父任务成功率=0%，触发失败告警，执行补偿逻辑                                 |
| BND-003  | 验证父任务终止对子任务的影响 | 父任务超时终止，子任务正在执行                           | 正在执行的子任务强制终止，标记为failed，未执行的子任务标记为cancelled       |
| BND-004  | 验证存储故障处理             | 子任务执行成功但结果写入数据库失败                       | 子任务标记为success（核心逻辑完成），结果写入失败记录告警，不影响父任务汇总 |
| BND-005  | 验证超大数量子任务           | 生成1000个pro_bar子任务（trade_date=100，stock_code=10） | 子任务分批次执行，内存占用≤阈值（如500MB），无OOM                          |
| BND-006  | 验证网络中断恢复             | 子任务执行中网络中断，恢复后                             | 中断的子任务按重试次数重试，未中断的子任务正常执行                          |

### 8. 性能测试（非功能：效率）

| 测试点ID | 测试目的           | 测试场景                       | 预期结果                                           |
| -------- | ------------------ | ------------------------------ | -------------------------------------------------- |
| PERF-001 | 验证子任务生成性能 | 生成1000个子任务，统计生成耗时 | 生成耗时≤1s（纯内存操作），无明显卡顿             |
| PERF-002 | 验证DAG重排序性能  | 插入1000个子任务后重排序       | 拓扑排序耗时≤2s，满足业务超时要求                 |
| PERF-003 | 验证并发执行性能   | batchSize=10，执行100个子任务  | 总执行耗时≈单任务耗时×10（并发生效），无资源抢占 |
| PERF-004 | 验证结果汇总性能   | 汇总1000个子任务结果           | 汇总耗时≤500ms，无循环遍历性能瓶颈                |

## 三、测试落地建议

### 1. 测试环境分层

- **单元测试**：覆盖参数注入、子任务生成、DAG排序等纯逻辑模块（mock存储/API）；
- **集成测试**：部署最小化引擎，测试子任务全生命周期（真实存储+mock Tushare API）；
- **压测**：模拟1000+子任务场景，验证性能和资源占用；
- **混沌测试**：注入网络中断、存储故障、API限流等异常，验证鲁棒性。

### 2. 关键断言规则

- 子任务数量 = 依赖数据维度乘积（如交易日数×股票代码数）；
- DAG拓扑顺序满足「依赖前置」，无环；
- 父任务状态 = 子任务成功率 ≥ 阈值 → success，否则 failed；
- 回调触发次数 = 子任务状态变化次数 × 绑定的回调数；
- 结果汇总的total_data = 所有成功子任务的data_count之和。

### 3. 测试数据准备

- 有效测试集：trade_cal返回3个交易日，stock_basic返回2个股票代码；
- 空测试集：trade_cal返回空列表；
- 异常测试集：trade_cal返回无效日期（20251301）、stock_basic返回空代码。

## 四、核心风险点（测试重点关注）

1. 子任务ID重复导致DAG节点冲突；
2. DAG调整后拓扑排序错误，子任务执行顺序混乱；
3. 回调失败导致子任务/父任务状态异常；
4. 大量子任务生成导致内存溢出；
5. 部分子任务失败后，父任务成功率计算错误；
6. 参数注入时类型转换错误（如数字→字符串）导致API调用失败。

通过以上测试点的全覆盖，可确保子任务「生成→执行→回调→结果→参数」全生命周期的正确性，适配量化数据下载的业务场景，同时保障任务引擎的稳定性和可靠性。
