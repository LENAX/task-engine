# 缺失核心功能清单

## 概述

本文档基于设计文档和当前代码实现，列出还缺少的核心功能。当前核心工作流程已完整实现，以下功能为扩展功能或可选功能。

---

## 一、高优先级缺失功能（影响核心可用性）

### 1. ❌ 函数元数据持久化（部分缺失）

**状态**: 接口已定义，但未完全启用

**当前情况**:
- ✅ `JobFunctionRepository` 接口已定义
- ✅ SQLite实现已完成（`jobFunctionRepo`）
- ❌ Engine创建时传入`nil`，未启用持久化
- ❌ 系统重启后无法自动恢复函数

**影响**:
- 函数注册仅在内存中，系统重启后需要重新注册
- 无法实现"Job函数自动注册与重启恢复"的完整设计

**需要完成**:
1. 修改`Engine.NewEngine()`，传入`JobFunctionRepository`
2. 修改`FunctionRegistry.NewFunctionRegistry()`，传入repo
3. 实现Engine启动时的函数恢复流程
4. 测试函数持久化和恢复功能

**优先级**: 🔴 高（影响核心设计目标）

---

### 2. ❌ 插件扩展机制（部分缺失）

**状态**: 接口已定义，但未集成到Engine

**当前情况**:
- ✅ `Plugin` 接口已定义（`pkg/plugin/plugin.go`）
- ✅ 示例插件已实现（`email_alert.go`, `sms_alert.go`）
- ❌ 缺少`PluginManager`实现
- ❌ 未集成到Engine和Workflow生命周期
- ❌ Task执行失败/成功时未触发插件

**影响**:
- 无法实现邮件通知、短信告警等扩展功能
- 无法在Workflow/Task状态变更时触发自定义逻辑

**需要完成**:
1. 实现`PluginManager`（注册、加载、触发）
2. 在Engine中集成PluginManager
3. 在Task执行成功/失败/超时时触发对应插件
4. 在Workflow状态变更时触发对应插件
5. 支持通过Builder配置插件绑定规则

**优先级**: 🟡 中（扩展功能，不影响核心流程）

---

## 二、中优先级缺失功能（增强功能）

### 3. ❌ HTTP API服务

**状态**: 完全未实现

**当前情况**:
- ❌ 无HTTP API实现
- ❌ 无API路由定义
- ❌ 无API文档

**设计文档要求**:
```
/api/v1/workflows             POST  创建并提交Workflow
/api/v1/workflows/{id}        GET   查询Workflow状态
/api/v1/workflows/{id}/start  POST  启动Workflow
/api/v1/workflows/{id}/pause  POST  暂停Workflow
/api/v1/workflows/{id}/resume POST  恢复Workflow
/api/v1/tasks/{id}            GET   查询Task执行日志
/api/v1/plugins/{name}        POST  触发自定义插件
```

**影响**:
- 无法通过HTTP远程管控引擎
- 无法跨系统集成
- 需要通过代码直接调用Engine API

**需要完成**:
1. 实现HTTP服务器（使用`net/http`或`gin`/`echo`框架）
2. 实现RESTful API路由
3. 实现请求参数校验和错误处理
4. 实现JSON序列化/反序列化
5. 编写API文档和测试用例

**优先级**: 🟡 中（增强功能，可通过代码直接使用）

---

### 4. ❌ 定时调度（Cron）

**状态**: 完全未实现

**当前情况**:
- ❌ 无Cron调度器实现
- ❌ WorkflowBuilder不支持`WithCronExpr()`
- ❌ Engine无定时触发逻辑

**设计文档要求**:
- 支持Crontab表达式配置
- 支持周期性定时触发WorkflowInstance创建
- 支持定时开关（启用/禁用）

**影响**:
- 无法实现定时任务（如每天凌晨同步数据）
- 需要外部系统（如cron）触发

**需要完成**:
1. 集成第三方Cron库（如`robfig/cron`）
2. 实现定时调度器模块
3. 在WorkflowBuilder中添加`WithCronExpr()`方法
4. 在Engine中实现定时触发逻辑
5. 实现定时开关和状态同步

**优先级**: 🟡 中（扩展功能，设计文档标记为后续迭代）

---

## 三、低优先级缺失功能（可选功能）

### 5. ❌ SAGA事务机制

**状态**: 完全未实现

**当前情况**:
- ❌ 无SAGA事务协调器
- ❌ TaskBuilder不支持`WithCompensationFunction()`
- ❌ 无补偿逻辑执行

**设计文档要求**:
- 支持Task执行失败后的补偿逻辑
- 按反向顺序执行补偿
- 保障最终一致性

**影响**:
- 无法实现分布式事务的最终一致性
- Task执行失败后无法自动回滚

**需要完成**:
1. 实现SAGA事务协调器
2. 在TaskBuilder中添加`WithCompensationFunction()`
3. 实现补偿逻辑执行（反向顺序）
4. 实现事务状态管理
5. 编写测试用例

**优先级**: 🟢 低（可选功能，设计文档标记为可选）

---

### 6. ❌ 多数据库支持（MySQL/PostgreSQL）

**状态**: 仅SQLite实现

**当前情况**:
- ✅ SQLite实现完整
- ❌ MySQL实现缺失
- ❌ PostgreSQL实现缺失

**设计文档要求**:
- 支持SQLite（轻量部署）
- 支持PostgreSQL（高并发）
- 支持MySQL（通用场景）
- 通过配置切换数据库类型

**影响**:
- 仅支持SQLite，无法适配高并发场景
- 无法使用PostgreSQL的JSONB特性
- 无法适配MySQL部署环境

**需要完成**:
1. 实现MySQL版本的Repository
2. 实现PostgreSQL版本的Repository
3. 实现数据库适配工厂（根据配置选择实现）
4. 适配不同数据库的SQL语法差异
5. 编写多数据库切换测试

**优先级**: 🟢 低（SQLite已满足开发测试需求）

---

## 四、功能完整性对比

### 核心功能（必须实现）
| 功能 | 状态 | 完成度 |
|------|------|--------|
| 声明式任务定义 | ✅ 完成 | 100% |
| DAG自动编排 | ✅ 完成 | 100% |
| 并发调度 | ✅ 完成 | 100% |
| Workflow生命周期管控 | ✅ 完成 | 100% |
| 断点恢复 | ✅ 完成 | 100% |
| 优雅关闭 | ✅ 完成 | 100% |

### 扩展功能（增强可用性）
| 功能 | 状态 | 完成度 |
|------|------|--------|
| 函数元数据持久化 | ⚠️ 部分 | 60% (接口+实现完成，未启用) |
| 插件扩展机制 | ⚠️ 部分 | 30% (接口+示例完成，未集成) |
| HTTP API | ❌ 未实现 | 0% |
| 定时调度（Cron） | ❌ 未实现 | 0% |

### 可选功能（按需实现）
| 功能 | 状态 | 完成度 |
|------|------|--------|
| SAGA事务 | ❌ 未实现 | 0% |
| 多数据库支持 | ⚠️ 部分 | 33% (仅SQLite) |

---

## 五、开发建议

### 短期目标（1-2周）
1. **完成函数元数据持久化**
   - 启用JobFunctionRepository
   - 实现Engine启动时的函数恢复
   - 测试持久化和恢复流程

2. **集成插件机制**
   - 实现PluginManager
   - 集成到Engine和Task执行流程
   - 支持插件触发规则配置

### 中期目标（3-4周）
3. **实现HTTP API**
   - 实现基础API接口
   - 编写API文档
   - 集成测试

4. **实现定时调度**
   - 集成Cron库
   - 实现定时触发逻辑
   - 测试定时任务

### 长期目标（按需）
5. **SAGA事务机制**（可选）
6. **多数据库支持**（按部署需求）

---

## 六、总结

### 当前状态
- ✅ **核心工作流程**: 100%完成，已通过测试
- ⚠️ **扩展功能**: 部分完成，需要完善
- ❌ **可选功能**: 未实现，按需开发

### 关键缺失
1. **函数元数据持久化** - 影响系统重启后的函数恢复
2. **插件机制集成** - 影响扩展能力
3. **HTTP API** - 影响远程管控能力
4. **定时调度** - 影响定时任务场景

### 建议优先级
1. 🔴 **高优先级**: 函数元数据持久化（完善核心功能）
2. 🟡 **中优先级**: 插件机制集成、HTTP API、定时调度（增强可用性）
3. 🟢 **低优先级**: SAGA事务、多数据库支持（按需实现）

---

*最后更新: 2025-12-31*

