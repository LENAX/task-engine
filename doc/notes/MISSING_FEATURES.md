# 缺失核心功能清单

## 概述

本文档基于设计文档和当前代码实现，列出还缺少的核心功能。当前核心工作流程已完整实现，以下功能为扩展功能或可选功能。

---

## 一、高优先级缺失功能（影响核心可用性）

### 1. ❌ 持久化函数恢复（部分缺失）

**状态**: 接口已定义，但未完全启用

**当前情况**:
- ✅ `JobFunctionRepository` / `TaskHandlerRepository` 接口已定义
- ✅ SQLite实现已完成（`jobFunctionRepo` / `taskHandlerRepo`）
- ✅ `EngineBuilder` 通过 `initStorage` 创建 SQLite 仓库，并在 `NewEngineWithRepos` 中传入 `JobFunctionRepository` / `TaskHandlerRepository`，`FunctionRegistry` 已实际启用元数据持久化
- ⚠️ 引擎启动流程未内置“自动恢复函数实例”的封装逻辑，需要业务侧在重启后显式注册函数，或基于 `FunctionRegistry.RestoreFunctions` 组合 `funcMap` 进行恢复

**影响**:
- 函数注册仅在内存中，系统重启后需要重新注册
- 无法实现"Job函数自动注册与重启恢复"的完整设计

**需要完成**:
1. 设计并实现推荐的“函数恢复”使用方式（例如：在用户侧初始化阶段统一维护 `funcMap`，并调用 `FunctionRegistry.RestoreFunctions`），补充到文档与示例代码中
2. 视需要在 `EngineBuilder` 或辅助模块中提供一层轻量封装，简化“从持久化元数据恢复函数”的流程（保持可选，不强绑生命周期）
3. 增补“持久化 + 重启恢复”的集成测试（含模拟重启场景），验证注册、持久化、恢复的完整闭环

**优先级**: 🔴 高（影响重启后的函数恢复体验，基础设施已就绪，主要缺少统一用法与测试）

---

### 2. ❌ 事务支持（SAGA事务机制，部分缺失）

**状态**: 框架已实现，但功能不完整

**当前情况**:
- ✅ `DefaultCompensate` handler 已实现（框架）
- ✅ Workflow 支持 `Transactional` 和 `TransactionMode` 配置
- ⚠️ `DefaultCompensate` 只记录日志，未实现实际补偿动作执行
- ❌ 无SAGA事务协调器
- ❌ TaskBuilder不支持`WithCompensationFunction()`
- ❌ 无补偿逻辑自动执行机制

**设计文档要求**:
- 支持Task执行失败后的补偿逻辑
- 按反向顺序执行补偿
- 保障最终一致性

**影响**:
- 无法实现分布式事务的最终一致性
- Task执行失败后无法自动回滚
- 补偿逻辑需要手动实现，缺少统一框架

**需要完成**:
1. 完善 `DefaultCompensate` handler，支持实际补偿动作执行
2. 实现SAGA事务协调器
3. 在TaskBuilder中添加`WithCompensationFunction()`方法
4. 实现补偿逻辑自动执行（反向顺序）
5. 实现事务状态管理和追踪
6. 编写测试用例和文档

**优先级**: 🔴 高（影响数据一致性，核心功能）

---

## 二、中优先级缺失功能（增强功能）

### 4. ❌ 定时调度（Cron）

**状态**: 接口已定义，但未集成到Engine

**当前情况**:
- ✅ `Plugin` 接口已定义（`pkg/plugin/plugin.go`）
- ✅ 示例插件已实现（`email_alert.go`, `sms_alert.go`）
- ❌ 缺少`PluginManager`实现
- ❌ 未集成到Engine和Workflow生命周期
- ❌ Task执行失败/成功时未触发插件

**影响**:
- 无法实现邮件通知、短信告警等扩展功能
- 无法在Workflow/Task状态变更时触发自定义逻辑

**需要完成**:
1. 实现`PluginManager`（注册、加载、触发）
2. 在Engine中集成PluginManager
3. 在Task执行成功/失败/超时时触发对应插件
4. 在Workflow状态变更时触发对应插件
5. 支持通过Builder配置插件绑定规则

**优先级**: 🟢 低（扩展功能，不影响核心流程）

---

### 7. ❌ HTTP API服务

**状态**: 完全未实现

**当前情况**:
- ❌ 无HTTP API实现
- ❌ 无API路由定义
- ❌ 无API文档

**设计文档要求**:
```
/api/v1/workflows             POST  创建并提交Workflow
/api/v1/workflows/{id}        GET   查询Workflow状态
/api/v1/workflows/{id}/start  POST  启动Workflow
/api/v1/workflows/{id}/pause  POST  暂停Workflow
/api/v1/workflows/{id}/resume POST  恢复Workflow
/api/v1/tasks/{id}            GET   查询Task执行日志
/api/v1/plugins/{name}        POST  触发自定义插件
```

**影响**:
- 无法通过HTTP远程管控引擎
- 无法跨系统集成
- 需要通过代码直接调用Engine API

**需要完成**:
1. 实现HTTP服务器（使用`net/http`或`gin`/`echo`框架）
2. 实现RESTful API路由
3. 实现请求参数校验和错误处理
4. 实现JSON序列化/反序列化
5. 编写API文档和测试用例

**优先级**: 🟢 低（增强功能，可通过代码直接使用）

---

### 8. ❌ 其他支持不完全的特性

以下特性在 `implementation_support_analysis.md` 中标记为部分支持或不支持，但优先级相对较低：

#### 8.1 缓存短路机制 (GEN-002)
- **状态**: ❌ 不支持
- **说明**: 没有缓存机制，需要在Handler中实现
- **影响**: 无法在生成子任务前检查缓存，避免重复生成
- **优先级**: 🟢 低（可通过Handler实现）

#### 8.2 依赖关系重构 (DAG-002)
- **状态**: ⚠️ 部分支持
- **说明**: 子任务依赖可以更新，但下游任务的依赖重构需要手动处理
- **影响**: 动态调整DAG时，下游任务依赖关系可能不一致
- **优先级**: 🟢 低（高级功能，使用场景较少）

#### 8.3 并发控制增强 (EXEC-002)
- **状态**: ⚠️ 部分支持
- **说明**: `Executor` 有 `MaxConcurrency`，但没有 `batchSize` 限制
- **影响**: 无法限制同时执行的子任务批次大小
- **优先级**: 🟢 低（已有基本并发控制）

#### 8.4 子任务跳过逻辑 (EXEC-007)
- **状态**: ❌ 不支持
- **说明**: 没有跳过机制，需要在Handler中实现
- **影响**: 无法在特定条件下跳过子任务执行
- **优先级**: 🟢 低（可通过Handler实现）

#### 8.5 回调类型覆盖 (HOOK-001)
- **状态**: ⚠️ 部分支持
- **说明**: 支持 `Success` 和 `Failed` Handler，但没有 `Start` 和 `Compensate` 状态回调
- **影响**: 无法在任务开始时或补偿时触发回调
- **优先级**: 🟢 低（可通过扩展Handler实现）

#### 8.6 全局回调机制 (HOOK-006)
- **状态**: ❌ 不支持
- **说明**: 没有全局回调机制，所有回调都是任务级别的
- **影响**: 无法在Workflow级别设置全局回调
- **优先级**: 🟢 低（高级功能）

#### 8.7 结果覆盖逻辑 (RES-006)
- **状态**: ❌ 不支持
- **说明**: 没有结果覆盖逻辑，新结果会覆盖旧结果
- **影响**: 无法管理结果版本，无法保留历史结果
- **优先级**: 🟢 低（高级功能，使用场景较少）

#### 8.8 子任务执行全失败处理 (BND-002)
- **状态**: ❌ 不支持
- **说明**: 没有成功率计算和失败告警，需要在Handler中实现
- **影响**: 无法自动检测和处理子任务全部失败的情况
- **优先级**: 🟢 低（可通过Handler实现）

#### 8.9 父任务终止对子任务的影响 (BND-003)
- **状态**: ⚠️ 部分支持
- **说明**: 有 `Terminate` 机制，但没有强制终止正在执行的子任务
- **影响**: 父任务终止时，正在执行的子任务可能继续运行
- **优先级**: 🟢 低（可通过增强Terminate机制实现）

#### 8.10 存储故障处理 (BND-004)
- **状态**: ❌ 不支持
- **说明**: 没有存储故障处理，存储失败会记录日志但不影响任务状态
- **影响**: 存储故障时无法自动重试或降级
- **优先级**: 🟢 低（可通过增强存储层实现）

#### 8.11 网络中断恢复 (BND-006)
- **状态**: ⚠️ 部分支持
- **说明**: 有重试机制，但没有网络中断检测和恢复逻辑
- **影响**: 无法自动检测网络中断并恢复
- **优先级**: 🟢 低（可通过增强重试机制实现）

---

**状态**: 完全未实现

**当前情况**:
- ❌ 无Cron调度器实现
- ❌ WorkflowBuilder不支持`WithCronExpr()`
- ❌ Engine无定时触发逻辑

**设计文档要求**:
- 支持Crontab表达式配置
- 支持周期性定时触发WorkflowInstance创建
- 支持定时开关（启用/禁用）

**影响**:
- 无法实现定时任务（如每天凌晨同步数据）
- 需要外部系统（如cron）触发

**需要完成**:
1. 集成第三方Cron库（如`robfig/cron`）
2. 实现定时调度器模块
3. 在WorkflowBuilder中添加`WithCronExpr()`方法
4. 在Engine中实现定时触发逻辑
5. 实现定时开关和状态同步

**优先级**: 🟡 中（扩展功能，设计文档标记为后续迭代）

---

### 5. ❌ 多数据库支持（MySQL/PostgreSQL）

**状态**: 仅SQLite实现

**当前情况**:
- ✅ SQLite实现完整
- ❌ MySQL实现缺失
- ❌ PostgreSQL实现缺失

**设计文档要求**:
- 支持SQLite（轻量部署）
- 支持PostgreSQL（高并发）
- 支持MySQL（通用场景）
- 通过配置切换数据库类型

**影响**:
- 仅支持SQLite，无法适配高并发场景
- 无法使用PostgreSQL的JSONB特性
- 无法适配MySQL部署环境

**需要完成**:
1. 实现MySQL版本的Repository
2. 实现PostgreSQL版本的Repository
3. 实现数据库适配工厂（根据配置选择实现）
4. 适配不同数据库的SQL语法差异
5. 编写多数据库切换测试

**优先级**: 🟡 中（SQLite已满足开发测试需求，但生产环境可能需要MySQL/PostgreSQL）

---

## 三、低优先级缺失功能（可选功能）

### 6. ❌ 插件扩展机制（部分缺失）

## 四、功能完整性对比

### 核心功能（必须实现）
| 功能 | 状态 | 完成度 |
|------|------|--------|
| 声明式任务定义 | ✅ 完成 | 100% |
| DAG自动编排 | ✅ 完成 | 100% |
| 并发调度 | ✅ 完成 | 100% |
| Workflow生命周期管控 | ✅ 完成 | 100% |
| 断点恢复 | ✅ 完成 | 100% |
| 优雅关闭 | ✅ 完成 | 100% |

### 扩展功能（增强可用性）
| 功能 | 状态 | 完成度 |
|------|------|--------|
| 持久化函数恢复 | ⚠️ 部分 | 80%（接口+SQLite实现+Engine接入已完成，缺统一恢复方案与集成测试） |
| 事务支持（SAGA） | ⚠️ 部分 | 30%（DefaultCompensate框架已实现，缺完整协调器和自动执行） |
| 定时调度（Cron） | ❌ 未实现 | 0% |
| 多数据库支持 | ⚠️ 部分 | 33% (仅SQLite) |
| 插件扩展机制 | ⚠️ 部分 | 30%（接口+示例完成，未集成） |
| HTTP API | ❌ 未实现 | 0% |

---

## 五、开发建议

### 短期目标（1-2周）
1. **完成持久化函数恢复**
   - 设计并实现推荐的函数恢复使用方式
   - 在EngineBuilder或辅助模块中提供轻量封装
   - 补充集成测试（含模拟重启场景）

2. **实现动态参数注入**
   - 设计动态参数注入机制
   - 实现参数注入接口
   - 支持条件参数注入
   - 编写测试用例

### 中期目标（3-4周）
3. **完善事务支持（SAGA）**
   - 完善DefaultCompensate handler，支持实际补偿动作执行
   - 实现SAGA事务协调器
   - 在TaskBuilder中添加WithCompensationFunction()方法
   - 实现补偿逻辑自动执行

4. **实现定时调度**
   - 集成Cron库
   - 实现定时触发逻辑
   - 测试定时任务

5. **多数据库支持**
   - 实现MySQL版本的Repository
   - 实现PostgreSQL版本的Repository
   - 实现数据库适配工厂

### 长期目标（按需）
6. **插件机制集成**
   - 实现PluginManager
   - 集成到Engine和Task执行流程
   - 支持插件触发规则配置

7. **实现HTTP API**
   - 实现基础API接口
   - 编写API文档
   - 集成测试

8. **其他支持不完全的特性**（按需实现）

---

## 六、总结

### 当前状态
- ✅ **核心工作流程**: 100%完成，已通过测试
- ⚠️ **扩展功能**: 部分完成，需要完善
- ❌ **可选功能**: 未实现，按需开发

### 关键缺失（按优先级排序）
1. **持久化函数恢复** - 影响系统重启后的函数恢复体验（基础设施已具备，缺统一恢复方案与测试）
2. **事务支持（SAGA）** - 影响数据一致性，补偿逻辑框架已实现但需完善
3. **定时调度** - 影响定时任务场景
4. **多数据库支持** - 影响生产环境部署（当前仅支持SQLite）
5. **插件机制集成** - 影响扩展能力

### 建议优先级
1. 🔴 **高优先级**: 
   - 持久化函数恢复（统一恢复方案 + 集成测试）
   - 事务支持（SAGA事务协调器和自动补偿执行）
2. 🟡 **中优先级**: 
   - 定时调度（Cron支持）
   - 多数据库支持（MySQL/PostgreSQL）
3. 🟢 **低优先级**: 
   - 插件机制集成
   - HTTP API
   - 其他支持不完全的特性（按需实现）

---

*最后更新: 2026-01-06（已按新优先级重新排序，并添加支持不完全的特性）*

