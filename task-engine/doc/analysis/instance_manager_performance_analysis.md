# WorkflowInstanceManager æ€§èƒ½åˆ†æ

## æ¦‚è¿°

æœ¬æ–‡æ¡£åˆ†æ `instance_manager.go` ä¸­ä¸»è¦æ–¹æ³•çš„æ—¶é—´å’Œå†…å­˜å¼€é”€ï¼Œä½¿ç”¨å¤§Oè¡¨ç¤ºæ³•æè¿°å¤æ‚åº¦ã€‚

**å…³é”®æ•°æ®ç»“æ„ï¼š**
- `processedNodes`: sync.Map (å·²å¤„ç†ä»»åŠ¡ID -> bool)
- `readyTasksSet`: sync.Map (å°±ç»ªä»»åŠ¡ID -> workflow.Task)
- `contextData`: sync.Map (ä»»åŠ¡ç»“æœæ•°æ®)
- `parentSubTaskStats`: sync.Map (çˆ¶ä»»åŠ¡ID -> *parentSubTaskStats)
- `dag`: DAGå›¾ç»“æ„

**ç¬¦å·è¯´æ˜ï¼š**
- N = æ€»ä»»åŠ¡æ•°
- R = å°±ç»ªä»»åŠ¡æ•°ï¼ˆé€šå¸¸ << Nï¼‰
- D = ä»»åŠ¡ä¾èµ–æ•°ï¼ˆå¹³å‡æ¯ä¸ªä»»åŠ¡çš„ä¾èµ–æ•°ï¼‰
- P = çˆ¶ä»»åŠ¡çš„å­ä»»åŠ¡æ•°
- C = ä¸‹æ¸¸ä»»åŠ¡æ•°ï¼ˆå¹³å‡æ¯ä¸ªä»»åŠ¡çš„å­ä»»åŠ¡æ•°ï¼‰

---

## 1. NewWorkflowInstanceManager

**æ—¶é—´å¤æ‚åº¦ï¼š** O(N + E)
- `dag.BuildDAG`: O(N + E)ï¼Œå…¶ä¸­Eæ˜¯ä¾èµ–è¾¹æ•°
- `dag.DetectCycle`: O(N + E)ï¼Œæ£€æµ‹å¾ªç¯ä¾èµ–
- `initReadyTasksSet`: O(R)ï¼ŒRæ˜¯åˆå§‹å°±ç»ªä»»åŠ¡æ•°
- `readyTasksSet.Range`: O(R)ï¼ŒéªŒè¯åˆå§‹åŒ–

**ç©ºé—´å¤æ‚åº¦ï¼š** O(N + E)
- DAGç»“æ„ï¼šO(N + E)
- sync.Mapåˆå§‹åŒ–ï¼šO(1)ï¼ˆå»¶è¿Ÿåˆ†é…ï¼‰
- é€šé“ï¼šO(1)ï¼ˆå›ºå®šå¤§å°10ï¼‰

**ä¼˜åŒ–å»ºè®®ï¼š**
- âœ… å·²ä¼˜åŒ–ï¼šä½¿ç”¨sync.Mapå»¶è¿Ÿåˆ†é…
- âœ… å·²ä¼˜åŒ–ï¼šDAGæ„å»ºåœ¨åˆå§‹åŒ–æ—¶å®Œæˆ

---

## 2. Start

**æ—¶é—´å¤æ‚åº¦ï¼š** O(1)
- çŠ¶æ€æ›´æ–°ï¼šO(1)
- æ•°æ®åº“æ›´æ–°ï¼šO(1)ï¼ˆå•æ¬¡æ“ä½œï¼‰
- å¯åŠ¨goroutineï¼šO(1)

**ç©ºé—´å¤æ‚åº¦ï¼š** O(1)
- å›ºå®šå¼€é”€ï¼š2ä¸ªgoroutine

**ä¼˜åŒ–å»ºè®®ï¼š**
- âœ… å·²ä¼˜åŒ–ï¼šéé˜»å¡çŠ¶æ€æ›´æ–°

---

## 3. taskSubmissionGoroutineï¼ˆä¸»å¾ªç¯ï¼‰

**æ—¶é—´å¤æ‚åº¦ï¼š** 
- **å•æ¬¡å¾ªç¯ï¼š** O(R + RÃ—D)
  - `getAvailableTasks`: O(R + RÃ—D)ï¼ˆè§ä¸‹æ–‡ï¼‰
  - ä»»åŠ¡æäº¤ï¼šO(R)
  - `isAllTasksCompleted`: O(N)ï¼ˆè§ä¸‹æ–‡ï¼‰
  - `recoverPendingTasks`: O(N)ï¼ˆè§ä¸‹æ–‡ï¼‰
- **æ€»ä½“ï¼š** O(NÃ—(R + RÃ—D))ï¼Œä½†å®é™…æ‰§è¡Œæ¬¡æ•°å–å†³äºä»»åŠ¡å®Œæˆé€Ÿåº¦

**ç©ºé—´å¤æ‚åº¦ï¼š** O(R)
- `availableTasks`åˆ‡ç‰‡ï¼šO(R)

**å…³é”®ä¼˜åŒ–ç‚¹ï¼š**
- âœ… å·²ä¼˜åŒ–ï¼šä½¿ç”¨500msç­‰å¾…å‡å°‘æ•°æ®åº“æŸ¥è¯¢é¢‘ç‡
- âœ… å·²ä¼˜åŒ–ï¼šåªåœ¨å¿…è¦æ—¶è°ƒç”¨`recoverPendingTasks`
- âš ï¸ æ½œåœ¨é—®é¢˜ï¼šé¢‘ç¹è°ƒç”¨`getAvailableTasks`å¯èƒ½å¯¼è‡´é”ç«äº‰

---

## 4. getAvailableTasks

**æ—¶é—´å¤æ‚åº¦ï¼š** O(R + RÃ—D)
- `readyTasksSet.Range`: O(R) - éå†æ‰€æœ‰å°±ç»ªä»»åŠ¡
- å¯¹æ¯ä¸ªä»»åŠ¡ï¼š
  - `processedNodes.Load`: O(1) - sync.MapæŸ¥æ‰¾
  - `validateAndMapParams`: O(D) - æ£€æŸ¥ä¾èµ–å’Œå‚æ•°æ˜ å°„
- åˆ é™¤å·²å¤„ç†ä»»åŠ¡ï¼šO(R)

**ç©ºé—´å¤æ‚åº¦ï¼š** O(R)
- `available`åˆ‡ç‰‡ï¼šO(R)

**é”ç«äº‰åˆ†æï¼š**
- ä½¿ç”¨`readyTasksMu.RLock()`ä¿æŠ¤Rangeæ“ä½œ
- åœ¨é”å¤–åˆ é™¤ä»»åŠ¡ï¼ˆé¿å…åœ¨Rangeä¸­ä¿®æ”¹ï¼‰
- âš ï¸ **æ½œåœ¨é—®é¢˜ï¼š** å¦‚æœRå¾ˆå¤§ï¼Œè¯»é”æŒæœ‰æ—¶é—´è¾ƒé•¿

**ä¼˜åŒ–å»ºè®®ï¼š**
- âœ… å·²ä¼˜åŒ–ï¼šä½¿ç”¨è¯»é”è€Œéå†™é”
- âœ… å·²ä¼˜åŒ–ï¼šåœ¨é”å¤–åˆ é™¤ä»»åŠ¡
- ğŸ’¡ å¯è€ƒè™‘ï¼šåˆ†æ‰¹å¤„ç†ï¼Œå‡å°‘å•æ¬¡é”æŒæœ‰æ—¶é—´

---

## 5. validateAndMapParams

**æ—¶é—´å¤æ‚åº¦ï¼š** O(DÃ—P)
- æ£€æŸ¥å¿…éœ€å‚æ•°ï¼šO(RPÃ—D)ï¼Œå…¶ä¸­RPæ˜¯å¿…éœ€å‚æ•°æ•°
- ResultMappingï¼šO(RMÃ—D)ï¼Œå…¶ä¸­RMæ˜¯æ˜ å°„è§„åˆ™æ•°
- æ€»ä½“ï¼šO(DÃ—P)ï¼ŒP = max(RP, RM)

**ç©ºé—´å¤æ‚åº¦ï¼š** O(P)
- `missingParams`åˆ‡ç‰‡ï¼šO(RP)
- `missingFields`åˆ‡ç‰‡ï¼šO(RM)

**å…³é”®æ“ä½œï¼š**
- `contextData.Load`: O(1) - sync.MapæŸ¥æ‰¾
- `workflow.GetTaskIDByName`: O(1) - mapæŸ¥æ‰¾ï¼ˆå‡è®¾å·²å»ºç«‹ç´¢å¼•ï¼‰

**ä¼˜åŒ–å»ºè®®ï¼š**
- âœ… å·²ä¼˜åŒ–ï¼šä½¿ç”¨sync.Mapå¿«é€ŸæŸ¥æ‰¾
- ğŸ’¡ å¯è€ƒè™‘ï¼šç¼“å­˜ä»»åŠ¡IDæ˜ å°„ï¼Œé¿å…é‡å¤æŸ¥æ‰¾

---

## 6. injectCachedResults

**æ—¶é—´å¤æ‚åº¦ï¼š** O(DÃ—M)
- éå†ä¾èµ–ï¼šO(D)
- å¯¹æ¯ä¸ªä¾èµ–ï¼š
  - ç¼“å­˜æŸ¥æ‰¾ï¼šO(1)
  - ResultMappingå¤„ç†ï¼šO(M)ï¼ŒMæ˜¯æ˜ å°„è§„åˆ™æ•°
  - RequiredParamsæ£€æŸ¥ï¼šO(P)ï¼ŒPæ˜¯å¿…éœ€å‚æ•°æ•°
- æ€»ä½“ï¼šO(DÃ—M)

**ç©ºé—´å¤æ‚åº¦ï¼š** O(1)
- å±€éƒ¨å˜é‡ï¼šO(1)

**ä¼˜åŒ–å»ºè®®ï¼š**
- âœ… å·²ä¼˜åŒ–ï¼šä½¿ç”¨ç¼“å­˜é¿å…é‡å¤è®¡ç®—
- âœ… å·²ä¼˜åŒ–ï¼šæå‰è¿”å›ï¼ˆå¦‚æœç¼“å­˜æœªå‘½ä¸­ï¼‰

---

## 7. onTaskCompleted

**æ—¶é—´å¤æ‚åº¦ï¼š** O(C + CÃ—P)
- `readyTasksSet.Delete`: O(1)
- æ£€æŸ¥å­ä»»åŠ¡ï¼šO(1)ï¼ˆå¦‚æœIsSubTaskï¼‰
  - `checkParentTaskStatus`: O(1)ï¼ˆè§ä¸‹æ–‡ï¼‰
- æ£€æŸ¥ä¸‹æ¸¸ä»»åŠ¡ï¼šO(C)
  - `dag.GetChildren`: O(C)
  - `checkAndAddToReady`: O(P)ï¼ˆè§ä¸‹æ–‡ï¼‰
- æ€»ä½“ï¼šO(C + CÃ—P)

**ç©ºé—´å¤æ‚åº¦ï¼š** O(1)

**å…³é”®è·¯å¾„ï¼š**
- å­ä»»åŠ¡è·¯å¾„ï¼šO(1) - å¿«é€Ÿè·¯å¾„
- ä¸‹æ¸¸ä»»åŠ¡è·¯å¾„ï¼šO(CÃ—P) - ä¸»è¦å¼€é”€

**ä¼˜åŒ–å»ºè®®ï¼š**
- âœ… å·²ä¼˜åŒ–ï¼šä½¿ç”¨sync.Mapå¿«é€Ÿåˆ é™¤
- âœ… å·²ä¼˜åŒ–ï¼šæå‰è¿”å›ï¼ˆå¦‚æœæ— ä¸‹æ¸¸ä»»åŠ¡ï¼‰

---

## 8. checkAndAddToReady

**æ—¶é—´å¤æ‚åº¦ï¼š** O(P)
- `readyTasksSet.Load`: O(1)
- `dag.GetParents`: O(P)ï¼ŒPæ˜¯çˆ¶ä»»åŠ¡æ•°
- æ£€æŸ¥çˆ¶èŠ‚ç‚¹ï¼šO(P)
- `readyTasksSet.Store`: O(1)
- æ€»ä½“ï¼šO(P)

**ç©ºé—´å¤æ‚åº¦ï¼š** O(1)

**é”ç«äº‰åˆ†æï¼š**
- ä½¿ç”¨`readyTasksMu.Lock()`ä¿æŠ¤å¤åˆæ“ä½œ
- âš ï¸ **æ½œåœ¨é—®é¢˜ï¼š** å¦‚æœPå¾ˆå¤§ï¼Œå†™é”æŒæœ‰æ—¶é—´è¾ƒé•¿

**ä¼˜åŒ–å»ºè®®ï¼š**
- âœ… å·²ä¼˜åŒ–ï¼šåŒé‡æ£€æŸ¥é¿å…é‡å¤æ·»åŠ 
- âœ… å·²ä¼˜åŒ–ï¼šæå‰è¿”å›ï¼ˆå¦‚æœå·²å­˜åœ¨ï¼‰

---

## 9. checkParentTaskStatus

**æ—¶é—´å¤æ‚åº¦ï¼š** O(1)
- MapæŸ¥æ‰¾ï¼šO(1)
- ç»Ÿè®¡ä¿¡æ¯è¯»å–ï¼šO(1)
- çŠ¶æ€æ›´æ–°ï¼šO(1)
- `onTaskCompleted`: O(C + CÃ—P)ï¼ˆè§ä¸Šæ–‡ï¼‰

**ç©ºé—´å¤æ‚åº¦ï¼š** O(1)

**ä¼˜åŒ–å»ºè®®ï¼š**
- âœ… å·²ä¼˜åŒ–ï¼šä½¿ç”¨Mapç»Ÿè®¡è€Œééå†æ‰€æœ‰å­ä»»åŠ¡
- âœ… å·²ä¼˜åŒ–ï¼šä½¿ç”¨è¯»å†™é”ä¿æŠ¤ç»Ÿè®¡ä¿¡æ¯

---

## 10. isAllTasksCompleted

**æ—¶é—´å¤æ‚åº¦ï¼š** O(N + R)
- `workflow.GetTasks`: O(1)ï¼ˆè¿”å›mapå¼•ç”¨ï¼‰
- `processedNodes.Range`: O(N) - éå†æ‰€æœ‰å·²å¤„ç†ä»»åŠ¡
- `readyTasksSet.Range`: O(R) - éå†æ‰€æœ‰å°±ç»ªä»»åŠ¡
- æ€»ä½“ï¼šO(N + R)

**ç©ºé—´å¤æ‚åº¦ï¼š** O(1)

**ä¼˜åŒ–å»ºè®®ï¼š**
- âœ… å·²ä¼˜åŒ–ï¼šä½¿ç”¨Rangeè€Œéè½¬æ¢ä¸ºslice
- âš ï¸ **æ½œåœ¨é—®é¢˜ï¼š** å¦‚æœNå¾ˆå¤§ï¼ŒRangeæ“ä½œå¯èƒ½è¾ƒæ…¢
- ğŸ’¡ å¯è€ƒè™‘ï¼šç»´æŠ¤è®¡æ•°å™¨ï¼Œé¿å…æ¯æ¬¡éå†

---

## 11. recoverPendingTasks

**æ—¶é—´å¤æ‚åº¦ï¼š** O(N + NÃ—D)
- æ•°æ®åº“æŸ¥è¯¢ï¼šO(N) - è·å–æ‰€æœ‰ä»»åŠ¡å®ä¾‹
- å¯¹æ¯ä¸ªPending/Failedä»»åŠ¡ï¼š
  - `processedNodes.Load`: O(1)
  - `readyTasksSet.Load`: O(1)
  - `workflow.GetTasks`: O(1)
  - æ£€æŸ¥ä¾èµ–ï¼šO(D)
- æ€»ä½“ï¼šO(N + NÃ—D)

**ç©ºé—´å¤æ‚åº¦ï¼š** O(N)
- `taskInstances`åˆ‡ç‰‡ï¼šO(N)
- å±€éƒ¨å˜é‡ï¼šO(1)

**ä¼˜åŒ–å»ºè®®ï¼š**
- âœ… å·²ä¼˜åŒ–ï¼šåªåœ¨å¿…è¦æ—¶è°ƒç”¨ï¼ˆæ— å¯ç”¨ä»»åŠ¡æ—¶ï¼‰
- âœ… å·²ä¼˜åŒ–ï¼šæå‰è·³è¿‡å·²å¤„ç†ä»»åŠ¡
- âš ï¸ **æ½œåœ¨é—®é¢˜ï¼š** æ•°æ®åº“æŸ¥è¯¢å¯èƒ½è¾ƒæ…¢ï¼ˆI/Oæ“ä½œï¼‰

---

## 12. saveAllTaskStatuses

**æ—¶é—´å¤æ‚åº¦ï¼š** O(N + NÃ—U)
- æ•°æ®åº“æŸ¥è¯¢ï¼šO(N) - è·å–æ‰€æœ‰ä»»åŠ¡å®ä¾‹
- æ„å»ºæ˜ å°„ï¼šO(N)
- éå†æ‰€æœ‰ä»»åŠ¡ï¼šO(N)
  - çŠ¶æ€æ£€æŸ¥ï¼šO(1)
  - æ•°æ®åº“æ›´æ–°ï¼šO(U)ï¼ŒUæ˜¯å®é™…æ›´æ–°çš„ä»»åŠ¡æ•°
- æ€»ä½“ï¼šO(N + NÃ—U)

**ç©ºé—´å¤æ‚åº¦ï¼š** O(N)
- `taskInstanceMap`: O(N)
- å±€éƒ¨å˜é‡ï¼šO(1)

**ä¼˜åŒ–å»ºè®®ï¼š**
- âœ… å·²ä¼˜åŒ–ï¼šæ‰¹é‡ä¿å­˜è€Œéé€ä¸ªä¿å­˜
- âœ… å·²ä¼˜åŒ–ï¼šè·³è¿‡æœªå˜åŒ–çš„çŠ¶æ€
- âš ï¸ **æ½œåœ¨é—®é¢˜ï¼š** æ•°æ®åº“æ›´æ–°å¯èƒ½è¾ƒæ…¢ï¼ˆI/Oæ“ä½œï¼‰
- ğŸ’¡ å¯è€ƒè™‘ï¼šæ‰¹é‡æ›´æ–°SQLï¼Œå‡å°‘æ•°æ®åº“å¾€è¿”

---

## 13. AddSubTask

**æ—¶é—´å¤æ‚åº¦ï¼š** O(D + DÃ—E)
- éªŒè¯ï¼šO(1)
- `workflow.AddSubTask`: O(1)
- æ›´æ–°DAGä¾èµ–å…³ç³»ï¼šO(D)ï¼ŒDæ˜¯ä¸‹æ¸¸ä»»åŠ¡æ•°
  - å¯¹æ¯ä¸ªä¸‹æ¸¸ä»»åŠ¡ï¼šO(E)ï¼ŒEæ˜¯ä¾èµ–åˆ—è¡¨é•¿åº¦
- `dag.AddNode`: O(1)
- `incrementParentSubTaskTotal`: O(1)
- æ£€æŸ¥ä¾èµ–ï¼šO(P)ï¼ŒPæ˜¯å­ä»»åŠ¡ä¾èµ–æ•°
- æ€»ä½“ï¼šO(D + DÃ—E + P)

**ç©ºé—´å¤æ‚åº¦ï¼š** O(1)
- å±€éƒ¨å˜é‡ï¼šO(1)

**å…³é”®æ“ä½œï¼š**
- DAGæ›´æ–°ï¼šO(DÃ—E) - ä¸»è¦å¼€é”€
- ä¾èµ–æ£€æŸ¥ï¼šO(P)

**ä¼˜åŒ–å»ºè®®ï¼š**
- âœ… å·²ä¼˜åŒ–ï¼šä½¿ç”¨sync.Mapå¿«é€ŸæŸ¥æ‰¾
- âš ï¸ **æ½œåœ¨é—®é¢˜ï¼š** å¦‚æœDå¾ˆå¤§ï¼Œä¾èµ–å…³ç³»æ›´æ–°å¯èƒ½è¾ƒæ…¢
- ğŸ’¡ å¯è€ƒè™‘ï¼šå»¶è¿Ÿæ›´æ–°DAGï¼Œæ‰¹é‡å¤„ç†

---

## 14. createTaskCompleteHandler / createTaskErrorHandler

**æ—¶é—´å¤æ‚åº¦ï¼š** O(1 + H)
- çŠ¶æ€æ›´æ–°ï¼šO(1)
- `processedNodes.Store`: O(1)
- Handleræ‰§è¡Œï¼šO(H)ï¼ŒHæ˜¯Handleræ‰§è¡Œæ—¶é—´ï¼ˆç”¨æˆ·ä»£ç ï¼‰
- `onTaskCompleted`: O(C + CÃ—P)ï¼ˆè§ä¸Šæ–‡ï¼‰
- ç¼“å­˜ä¿å­˜ï¼šO(1)
- æ€»ä½“ï¼šO(1 + H + C + CÃ—P)

**ç©ºé—´å¤æ‚åº¦ï¼š** O(1)
- å±€éƒ¨å˜é‡ï¼šO(1)
- Handlerå¯èƒ½åˆ†é…å†…å­˜ï¼ˆç”¨æˆ·ä»£ç ï¼‰

**ä¼˜åŒ–å»ºè®®ï¼š**
- âœ… å·²ä¼˜åŒ–ï¼šé¿å…æ•°æ®åº“æŸ¥è¯¢ï¼Œç›´æ¥ä½¿ç”¨workflow.Task
- âœ… å·²ä¼˜åŒ–ï¼šå¼‚æ­¥æ‰§è¡ŒHandlerï¼ˆåœ¨goroutineä¸­ï¼‰

---

## 15. createBreakpoint

**æ—¶é—´å¤æ‚åº¦ï¼š** O(N + C)
- `processedNodes.Range`: O(N)
- `contextData.Range`: O(C)ï¼ŒCæ˜¯ä¸Šä¸‹æ–‡æ•°æ®é¡¹æ•°
- DAGå¿«ç…§ï¼šO(1)
- æ€»ä½“ï¼šO(N + C)

**ç©ºé—´å¤æ‚åº¦ï¼š** O(N + C)
- `completedTaskNames`: O(N)
- `contextDataMap`: O(C)
- `dagSnapshot`: O(1)

**ä¼˜åŒ–å»ºè®®ï¼š**
- âœ… å·²ä¼˜åŒ–ï¼šä½¿ç”¨Rangeè€Œéè½¬æ¢ä¸ºslice
- âš ï¸ **æ½œåœ¨é—®é¢˜ï¼š** å¦‚æœNæˆ–Cå¾ˆå¤§ï¼Œå†…å­˜å ç”¨å¯èƒ½è¾ƒé«˜

---

## 16. RestoreFromBreakpoint

**æ—¶é—´å¤æ‚åº¦ï¼š** O(N + C + RÃ—P)
- æ¢å¤processedNodesï¼šO(N)
- æ¢å¤contextDataï¼šO(C)
- é‡æ–°åˆå§‹åŒ–readyTasksSetï¼šO(RÃ—P)
  - å¯¹æ¯ä¸ªå°±ç»ªä»»åŠ¡ï¼šO(P)ï¼ŒPæ˜¯çˆ¶ä»»åŠ¡æ•°
- æ€»ä½“ï¼šO(N + C + RÃ—P)

**ç©ºé—´å¤æ‚åº¦ï¼š** O(N + C)
- é‡æ–°åˆ†é…sync.Mapï¼šO(N + C)

**ä¼˜åŒ–å»ºè®®ï¼š**
- âœ… å·²ä¼˜åŒ–ï¼šåŒé‡éªŒè¯ç¡®ä¿æ¢å¤æ­£ç¡®æ€§

---

## æ€§èƒ½ç“¶é¢ˆæ€»ç»“

### é«˜é¢‘æ“ä½œï¼ˆåœ¨å¾ªç¯ä¸­è°ƒç”¨ï¼‰

1. **getAvailableTasks** - O(R + RÃ—D)
   - è°ƒç”¨é¢‘ç‡ï¼šæ¯æ¬¡å¾ªç¯
   - ä¸»è¦å¼€é”€ï¼šå‚æ•°æ ¡éªŒå’Œæ˜ å°„

2. **onTaskCompleted** - O(C + CÃ—P)
   - è°ƒç”¨é¢‘ç‡ï¼šæ¯ä¸ªä»»åŠ¡å®Œæˆæ—¶
   - ä¸»è¦å¼€é”€ï¼šæ£€æŸ¥ä¸‹æ¸¸ä»»åŠ¡

3. **isAllTasksCompleted** - O(N + R)
   - è°ƒç”¨é¢‘ç‡ï¼šæ— å¯ç”¨ä»»åŠ¡æ—¶
   - ä¸»è¦å¼€é”€ï¼šéå†æ‰€æœ‰ä»»åŠ¡

### ä½é¢‘ä½†æ˜‚è´µçš„æ“ä½œ

1. **recoverPendingTasks** - O(N + NÃ—D)
   - è°ƒç”¨é¢‘ç‡ï¼šç³»ç»Ÿæ¢å¤æ—¶
   - ä¸»è¦å¼€é”€ï¼šæ•°æ®åº“æŸ¥è¯¢å’Œä¾èµ–æ£€æŸ¥

2. **saveAllTaskStatuses** - O(N + NÃ—U)
   - è°ƒç”¨é¢‘ç‡ï¼šå·¥ä½œæµå®Œæˆ/æš‚åœ/ç»ˆæ­¢æ—¶
   - ä¸»è¦å¼€é”€ï¼šæ•°æ®åº“æ›´æ–°

3. **AddSubTask** - O(D + DÃ—E)
   - è°ƒç”¨é¢‘ç‡ï¼šåŠ¨æ€ç”Ÿæˆå­ä»»åŠ¡æ—¶
   - ä¸»è¦å¼€é”€ï¼šDAGä¾èµ–å…³ç³»æ›´æ–°

### å†…å­˜ä½¿ç”¨

- **åŸºç¡€ç»“æ„ï¼š** O(N + E)
- **è¿è¡Œæ—¶æ•°æ®ï¼š** O(N + C)
  - processedNodes: O(N)
  - readyTasksSet: O(R) << N
  - contextData: O(C) â‰¤ N
  - parentSubTaskStats: O(P) << N

### ä¼˜åŒ–å»ºè®®

1. **ç»´æŠ¤è®¡æ•°å™¨** - é¿å…`isAllTasksCompleted`çš„O(N)éå†
2. **æ‰¹é‡æ•°æ®åº“æ“ä½œ** - å‡å°‘`saveAllTaskStatuses`çš„I/Oå¼€é”€
3. **å»¶è¿ŸDAGæ›´æ–°** - å‡å°‘`AddSubTask`çš„ä¾èµ–å…³ç³»æ›´æ–°å¼€é”€
4. **ç¼“å­˜ä»»åŠ¡IDæ˜ å°„** - å‡å°‘`validateAndMapParams`çš„æŸ¥æ‰¾å¼€é”€
5. **åˆ†æ‰¹å¤„ç†å°±ç»ªä»»åŠ¡** - å‡å°‘`getAvailableTasks`çš„é”æŒæœ‰æ—¶é—´

---

## å¹¶å‘å®‰å…¨åˆ†æ

### çº¿ç¨‹å®‰å…¨çš„æ•°æ®ç»“æ„

- âœ… `sync.Map` - å¹¶å‘å®‰å…¨çš„Map
- âœ… `sync.RWMutex` - è¯»å†™é”ä¿æŠ¤å¤åˆæ“ä½œ
- âœ… `sync.WaitGroup` - åç¨‹åŒæ­¥

### æ½œåœ¨çš„ç«äº‰æ¡ä»¶

1. **readyTasksSetçš„Rangeå’ŒDelete**
   - âœ… å·²è§£å†³ï¼šä½¿ç”¨è¯»é”ä¿æŠ¤Rangeï¼Œåœ¨é”å¤–åˆ é™¤

2. **processedNodesçš„å¹¶å‘è®¿é—®**
   - âœ… å·²è§£å†³ï¼šä½¿ç”¨sync.Mapï¼Œå¹¶å‘å®‰å…¨

3. **parentSubTaskStatsçš„å¹¶å‘æ›´æ–°**
   - âœ… å·²è§£å†³ï¼šä½¿ç”¨å†…éƒ¨é”ä¿æŠ¤ç»Ÿè®¡ä¿¡æ¯

---

## æ€»ç»“

`WorkflowInstanceManager`çš„è®¾è®¡åœ¨å¤§å¤šæ•°åœºæ™¯ä¸‹æ€§èƒ½è‰¯å¥½ï¼š

- âœ… ä½¿ç”¨sync.Mapå®ç°O(1)æŸ¥æ‰¾
- âœ… ä½¿ç”¨DAGä¼˜åŒ–ä¾èµ–æ£€æŸ¥
- âœ… æ‰¹é‡æ“ä½œå‡å°‘æ•°æ®åº“I/O
- âœ… å¼‚æ­¥å¤„ç†é¿å…é˜»å¡

ä¸»è¦æ€§èƒ½ç“¶é¢ˆï¼š
- âš ï¸ é«˜é¢‘æ“ä½œä¸­çš„å‚æ•°æ ¡éªŒï¼ˆO(RÃ—D)ï¼‰
- âš ï¸ æ•°æ®åº“I/Oæ“ä½œï¼ˆO(N)ï¼‰
- âš ï¸ å¤§é‡ä»»åŠ¡æ—¶çš„éå†æ“ä½œï¼ˆO(N)ï¼‰

å»ºè®®çš„ä¼˜åŒ–æ–¹å‘ï¼š
1. ç»´æŠ¤è®¡æ•°å™¨é¿å…éå†
2. æ‰¹é‡æ•°æ®åº“æ“ä½œ
3. ç¼“å­˜å¸¸ç”¨æŸ¥æ‰¾ç»“æœ
4. åˆ†æ‰¹å¤„ç†å‡å°‘é”ç«äº‰

